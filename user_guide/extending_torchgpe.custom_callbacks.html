
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Defining custom callbacks &#8212; TorchGPE 1.0.0 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/style.css?v=d110ab36" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=8d563738"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'user_guide/extending_torchgpe.custom_callbacks';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API reference" href="../api/index.html" />
    <link rel="prev" title="Defining custom potentials" href="extending_torchgpe.custom_potentials.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">TorchGPE package documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-external" href="https://www.quantumoptics.ethz.ch">
    Quantum Optics group
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/index.html">
    API reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/torchgpe" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-box fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/qo-eth/TorchGPE" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-external" href="https://www.quantumoptics.ethz.ch">
    Quantum Optics group
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    User guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/index.html">
    API reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/torchgpe" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-box fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/qo-eth/TorchGPE" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
</form></div>
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="about.html">About the package</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">TorchGPE quickstart</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Usage</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="fundamentals.html">Basic usage</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="fundamentals.gas_class.html">The Gas class</a></li>
<li class="toctree-l2"><a class="reference internal" href="fundamentals.potentials.html">Potentials</a></li>
<li class="toctree-l2"><a class="reference internal" href="fundamentals.callbacks.html">Callbacks</a></li>
</ul>
</details></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="extending_torchgpe.html">Advanced usage</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="extending_torchgpe.configuration_files.html">Using configuration files</a></li>
<li class="toctree-l2"><a class="reference internal" href="extending_torchgpe.custom_potentials.html">Defining custom potentials</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">Defining custom callbacks</a></li>
</ul>
</details></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">User Guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="extending_torchgpe.html" class="nav-link">Advanced usage</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Defining custom callbacks</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="defining-custom-callbacks">
<h1>Defining custom callbacks<a class="headerlink" href="#defining-custom-callbacks" title="Link to this heading">#</a></h1>
<p>Custom callbacks can be defined by subclassing the <a class="reference internal" href="../api/callbacks.html#torchgpe.utils.callbacks.Callback" title="torchgpe.utils.callbacks.Callback"><code class="xref py py-class docutils literal notranslate"><span class="pre">Callback</span></code></a> class. In the following example, we will define a callback that monitors where the maximum of the wave function is located and plots it in the xy-plane.</p>
<p>We will use the <code class="xref py py-class docutils literal notranslate"><span class="pre">DisplacedTrap</span></code> implemented in <a class="reference internal" href="extending_torchgpe.custom_potentials.html"><span class="doc">Defining custom potentials</span></a> to move the trap center along the custom trajectory</p>
<div class="math notranslate nohighlight">
\[\begin{split}x(\theta) = \sqrt{\theta} \cos(\theta) \, \mu m\\
y(\theta) = \sqrt{\theta} \sin(\theta) \, \mu m\end{split}\]</div>
<p>for <span class="math notranslate nohighlight">\(\theta \in \left[0,\,2\pi\right]\)</span>.</p>
<p>Before implementing the callback, we can follow the same procedure as in <a class="reference internal" href="extending_torchgpe.custom_potentials.html"><span class="doc">Defining custom potentials</span></a>, to see how the trap center moves along the trajectory.</p>
<a class="reference internal image-reference" href="../_images/extending_callback_propagate.gif"><img alt="Time evolution of the wavefunction in the :class:`DisplacedTrap` potential." class="align-center" src="../_images/extending_callback_propagate.gif" style="width: 450px;" />
</a>
<p>To implement the callback, we first define a class <code class="xref py py-class docutils literal notranslate"><span class="pre">TrajectoryMonitor</span></code> that inherits from <a class="reference internal" href="../api/callbacks.html#torchgpe.utils.callbacks.Callback" title="torchgpe.utils.callbacks.Callback"><code class="xref py py-class docutils literal notranslate"><span class="pre">Callback</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="kn">from</span><span class="w"> </span><span class="nn">torchgpe.utils.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callback</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="k">class</span><span class="w"> </span><span class="nc">TrajectoryMonitor</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
<span class="linenos">4</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">5</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</pre></div>
</div>
<p>All the subclasses of <a class="reference internal" href="../api/callbacks.html#torchgpe.utils.callbacks.Callback" title="torchgpe.utils.callbacks.Callback"><code class="xref py py-class docutils literal notranslate"><span class="pre">Callback</span></code></a> are provided with an instance of the <a class="reference internal" href="../api/gas.html#torchgpe.bec2D.gas.Gas" title="torchgpe.bec2D.gas.Gas"><code class="xref py py-class docutils literal notranslate"><span class="pre">Gas</span></code></a> class at runtime. Therefore, there is no need to pass the <a class="reference internal" href="../api/gas.html#torchgpe.bec2D.gas.Gas" title="torchgpe.bec2D.gas.Gas"><code class="xref py py-class docutils literal notranslate"><span class="pre">Gas</span></code></a> instance to the constructor of the callback.</p>
<p>There are four moments in the time evolution of the wave function where the callback can execute custom code, namely before the propagation starts, before and after each step of the split-step Fourier method, and when the propagation finishes. The callback can execute custom code at any of these moments by overriding <a class="reference internal" href="../stubs/torchgpe.utils.callbacks.Callback.on_propagation_begin.html#torchgpe.utils.callbacks.Callback.on_propagation_begin" title="torchgpe.utils.callbacks.Callback.on_propagation_begin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_propagation_begin()</span></code></a>, <a class="reference internal" href="../stubs/torchgpe.utils.callbacks.Callback.on_epoch_begin.html#torchgpe.utils.callbacks.Callback.on_epoch_begin" title="torchgpe.utils.callbacks.Callback.on_epoch_begin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_epoch_begin()</span></code></a>, <a class="reference internal" href="../stubs/torchgpe.utils.callbacks.Callback.on_epoch_end.html#torchgpe.utils.callbacks.Callback.on_epoch_end" title="torchgpe.utils.callbacks.Callback.on_epoch_end"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_epoch_end()</span></code></a>, or <a class="reference internal" href="../stubs/torchgpe.utils.callbacks.Callback.on_propagation_end.html#torchgpe.utils.callbacks.Callback.on_propagation_end" title="torchgpe.utils.callbacks.Callback.on_propagation_end"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_propagation_end()</span></code></a>.</p>
<p>In this example we will use <a class="reference internal" href="../stubs/torchgpe.utils.callbacks.Callback.on_propagation_begin.html#torchgpe.utils.callbacks.Callback.on_propagation_begin" title="torchgpe.utils.callbacks.Callback.on_propagation_begin"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_propagation_begin()</span></code></a> to initialize the arrays that will store the trajectory of the trap center, <a class="reference internal" href="../stubs/torchgpe.utils.callbacks.Callback.on_epoch_end.html#torchgpe.utils.callbacks.Callback.on_epoch_end" title="torchgpe.utils.callbacks.Callback.on_epoch_end"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_epoch_end()</span></code></a> to compute the trap center, and <a class="reference internal" href="../stubs/torchgpe.utils.callbacks.Callback.on_propagation_end.html#torchgpe.utils.callbacks.Callback.on_propagation_end" title="torchgpe.utils.callbacks.Callback.on_propagation_end"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_propagation_end()</span></code></a> to plot the trajectory.</p>
<p>Before the propagation starts, the callback is provided with the <a class="reference internal" href="../api/gas.html#torchgpe.bec2D.gas.Gas" title="torchgpe.bec2D.gas.Gas"><code class="xref py py-class docutils literal notranslate"><span class="pre">Gas</span></code></a> instance (stored in the <a class="reference internal" href="../stubs/torchgpe.utils.callbacks.Callback.gas.html#torchgpe.utils.callbacks.Callback.gas" title="torchgpe.utils.callbacks.Callback.gas"><code class="xref py py-attr docutils literal notranslate"><span class="pre">gas</span></code></a> attribute), and with important parameters of the propagation (stored in the <a class="reference internal" href="../stubs/torchgpe.utils.callbacks.Callback.propagation_params.html#torchgpe.utils.callbacks.Callback.propagation_params" title="torchgpe.utils.callbacks.Callback.propagation_params"><code class="xref py py-attr docutils literal notranslate"><span class="pre">propagation_params</span></code></a> dictionary).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently, only the <code class="docutils literal notranslate"><span class="pre">'potentials'</span></code>, <code class="docutils literal notranslate"><span class="pre">'time_step'</span></code> and <code class="docutils literal notranslate"><span class="pre">'N_iterations'</span></code> keys are available for imaginary or real time propagation. In addition, for real time propagation, <code class="docutils literal notranslate"><span class="pre">'final_time'</span></code> is also provided.</p>
</div>
<p>We use the <code class="xref py py-attr docutils literal notranslate"><span class="pre">N_iterations</span></code> parameter to allocate the array that will store the trajectory of the trap center.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span><span class="w"> </span><span class="nn">torchgpe.utils.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callback</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">class</span><span class="w"> </span><span class="nc">TrajectoryMonitor</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
<span class="linenos"> 6</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 7</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>    <span class="k">def</span><span class="w"> </span><span class="nf">on_propagation_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">10</span>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">propagation_params</span><span class="p">[</span><span class="s1">&#39;N_iterations&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
<p>Once the array is allocated, we can use <a class="reference internal" href="../stubs/torchgpe.utils.callbacks.Callback.on_epoch_end.html#torchgpe.utils.callbacks.Callback.on_epoch_end" title="torchgpe.utils.callbacks.Callback.on_epoch_end"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_epoch_end()</span></code></a> to compute the trap center. The callback is provided with the current iteration number, which we can use to store the trap center in the corresponding row of the array.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span><span class="w"> </span><span class="nn">torchgpe.utils.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callback</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="k">class</span><span class="w"> </span><span class="nc">TrajectoryMonitor</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
<span class="linenos"> 6</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 7</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>    <span class="k">def</span><span class="w"> </span><span class="nf">on_propagation_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">10</span>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">propagation_params</span><span class="p">[</span><span class="s1">&#39;N_iterations&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
<span class="linenos">11</span>
<span class="linenos">12</span>    <span class="k">def</span><span class="w"> </span><span class="nf">on_epoch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
<span class="linenos">13</span>        <span class="n">idx_x</span><span class="p">,</span> <span class="n">idx_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>
<span class="linenos">14</span>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">[</span><span class="n">epoch</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">idx_y</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">idx_x</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
</pre></div>
</div>
<p>In the code above, we use <code class="docutils literal notranslate"><span class="pre">np.unravel_index</span></code> to convert the index of the maximum of the wave function into the corresponding coordinates in the xy-plane.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The wave function of the gas might be stored on the GPU, while numpy arrays are stored on the CPU. Therefore, we need to move the wave function to the CPU before computing the maximum. This is done by calling <code class="docutils literal notranslate"><span class="pre">self.gas.density.argmax().cpu()</span></code>.</p>
</div>
<p>Finally, we use <a class="reference internal" href="../stubs/torchgpe.utils.callbacks.Callback.on_propagation_end.html#torchgpe.utils.callbacks.Callback.on_propagation_end" title="torchgpe.utils.callbacks.Callback.on_propagation_end"><code class="xref py py-meth docutils literal notranslate"><span class="pre">on_propagation_end()</span></code></a> to plot the trajectory of the trap center.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="kn">from</span><span class="w"> </span><span class="nn">torchgpe.utils.callbacks</span><span class="w"> </span><span class="kn">import</span> <span class="n">Callback</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="linenos"> 4</span><span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">class</span><span class="w"> </span><span class="nc">TrajectoryMonitor</span><span class="p">(</span><span class="n">Callback</span><span class="p">):</span>
<span class="linenos"> 7</span>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos"> 8</span>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>    <span class="k">def</span><span class="w"> </span><span class="nf">on_propagation_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">11</span>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">propagation_params</span><span class="p">[</span><span class="s1">&#39;N_iterations&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>
<span class="linenos">12</span>
<span class="linenos">13</span>    <span class="k">def</span><span class="w"> </span><span class="nf">on_epoch_begin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
<span class="linenos">14</span>        <span class="n">idx_x</span><span class="p">,</span> <span class="n">idx_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">density</span><span class="o">.</span><span class="n">argmax</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>
<span class="linenos">15</span>        <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">[</span><span class="n">epoch</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">idx_y</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">idx_x</span><span class="p">]</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
<span class="linenos">16</span>
<span class="linenos">17</span>    <span class="k">def</span><span class="w"> </span><span class="nf">on_propagation_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="linenos">18</span>
<span class="linenos">19</span>        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="linenos">20</span>        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">)</span>
<span class="linenos">21</span>        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos">22</span>        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">gas</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="linenos">23</span>        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="linenos">24</span>        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">)</span>
<span class="linenos">25</span>        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;/path/to/folder/trajectory.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The picture below, shows the trajectory of the trap center as measured by the callback, on top of the time evolution of the wave function.</p>
<a class="reference internal image-reference" href="../_images/extending_callback_propagate_comparison.gif"><img alt="Time evolution of the wavefunction in the :class:`DisplacedTrap` potential, and the trajectory of the trap center as measured by the callback." class="align-center" src="../_images/extending_callback_propagate_comparison.gif" style="width: 450px;" />
</a>
<p>The callback monitors the trajectory of the trap center and plots it in the xy-plane. The trajectory is consistent with the custom trajectory defined by the <code class="xref py py-class docutils literal notranslate"><span class="pre">DisplacedTrap</span></code> potential, with small deviations due to diabatic effects during the evolution.</p>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="extending_torchgpe.custom_potentials.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Defining custom potentials</p>
      </div>
    </a>
    <a class="right-next"
       href="../api/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">API reference</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2024, Quantum Optics group @ ETH Zurich.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>